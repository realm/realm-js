name: Publish Package Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Release version tag
        required: true
        type: string
        default: 'latest'
      commit:
        description: Optional commit to publish from
        required: false
        type: string
      package:
        description: 'Package'
        required: true
        default: 'realm'
        type: choice
        options:
        - '@realm/babel-plugin'
        - '@realm/common'
        - '@realm/network-transport'
        - '@realm/react'
        - '@realm/tools'
        - '@realm/web'

jobs:
  publish-release:
    runs-on: ubuntu-latest
    steps:
    - run: echo "Publishing release for ${{inputs.package}}"
    - uses: kanga333/variable-mapper@master
      with:
        key: "${{inputs.package}}"
        map: |
          {
            "@realm/babel-plugin": {
              "package-path": "packages/babel-plugin",
              "package-name": "@realm/babel-plugin",
              "version-prefix": "babel-plugin-",
              "release-title": "Realm Babel Plugin"
            },
            "@realm/common": {
              "package-path": "packages/common",
              "package-name": "@realm/common",
              "version-prefix": "realm-common-",
              "release-title": "Realm Common"
            },
            "@realm/network-transport": {
              "package-path": "packages/network-transport",
              "package-name": "@realm/network-transport",
              "version-prefix": "realm-network-transport-",
              "release-title": "Realm Network Transport"
            },
            "@realm/react": {
              "package-path": "packages/react",
              "package-name": "@realm/react",
              "version-prefix": "realm-react-",
              "release-title": "Realm React"
            },
            "@realm/tools": {
              "package-path": "packages/tools",
              "package-name": "@realm/tools",
              "version-prefix": "realm-tools-",
              "release-title": "Realm Tools"
            },
            "@realm/web": {
              "package-path": "packages/web",
              "package-name": "realm-web",
              "version-prefix": "realm-web-",
              "release-title": "Realm Web"
            }
          }

    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
        ref: ${{ inputs.commit || github.event.pull_request.head.sha }}

    - name: Install node modules
      run: npx lerna bootstrap --scope=${{ env.package-name }} --include-dependencies

    - name: Read version
      id: get-version
      run: |
        pkgVersion=$(jq -r .version ${{env.package-path}}/package.json)
        echo "::set-output name=version::$pkgVersion"
      shell: bash

    - name: Publish ${{env.release-title}} v${{ steps.get-version.outputs.version }} on NPM
      run: npm publish --tag '${{ inputs.tag}}'
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Find Release PR
      uses: juliangruber/find-pull-request-action@v1.7.0
      id: find-pull-request
      with:
        branch: ${{ github.ref }}

    - name: Merge Pull Request
      uses: juliangruber/merge-pull-request-action@8a13f2645ad8b6ada32f829b2fae9c0955a5265d
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        number: ${{ steps.find-pull-request.outputs.number }}
        method: squash

    - name: Checkout base branch (after merge)
      uses: actions/checkout@v3
      with:
        submodules: recursive
        ref: ${{ steps.find-pull-request.outputs.base-ref }}

    - name: Extract Changelog
      run: node scripts/extract-changelog.js ${{ steps.get-version.outputs.version }} ${{ github.workspace }}/${{env.package-path}}/CHANGELOG.md > EXTRACTED_CHANGELOG.md

    - name: Create Github Release
      uses: ncipollo/release-action@10c84d509b28aae3903113151bfd832314964f2e
      with:
        bodyFile: EXTRACTED_CHANGELOG.md
        name: ${{env.release-title}} v${{ steps.get-version.outputs.version }}
        tag: ${{env.version-prefix}}v${{ steps.get-version.outputs.version }}
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false

    - name: 'Post to #realm-releases'
      uses: realm/ci-actions/release-to-slack@v3
      with:
        changelog: EXTRACTED_CHANGELOG.md
        sdk: JavaScript
        webhook-url: ${{ secrets.SLACK_RELEASE_WEBHOOK }}
        version: ${{ steps.get-version.outputs.version }}
      # This job might fail due to failed markdown-to-slack conversion.
      continue-on-error: true

    - name: Update Changelog
      working-directory: ${{ github.workspace }}/${{env.package-path}}
      run: ${{ github.workspace }}/scripts/changelog-header.sh

    - name: Create vNext PR
      id: vnext-pr
      uses: peter-evans/create-pull-request@7380612b49221684fefa025244f2ef4008ae50ad
      with:
        branch: prepare-vnext
        title: Prepare for ${{env.release-title}} vNext
        body: Update Changelog for vNext
        delete-branch: true
        commit-message: Prepare for vNext
        base: ${{ steps.find-pull-request.outputs.base-ref }}

    - name: Merge Pull Request
      uses: juliangruber/merge-pull-request-action@8a13f2645ad8b6ada32f829b2fae9c0955a5265d
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        number: ${{ steps.vnext-pr.outputs.pull-request-number }}
        method: squash
